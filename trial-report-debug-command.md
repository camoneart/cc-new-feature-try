# /debug コマンド 試行レポート

## 基本情報

| 項目 | 内容 |
|------|------|
| Issue | #10 |
| 対象機能 | `/debug` コマンド |
| 導入バージョン | v2.1.30 |
| 試行バージョン | v2.1.52 |

## 機能概要

`/debug` はClaude Codeセッション中のトラブルシューティング用スラッシュコマンド。
セッション固有のデバッグログファイルを生成・参照し、問題の診断を支援する。

## 動作確認結果

### /debug 実行時の出力内容

1. **セッションデバッグログのパス**: `~/.claude/debug/<session-uuid>.txt`
2. **ログの総行数**: セッションの長さに応じて増加（今回は1,205行）
3. **直近20行のプレビュー**: ログ末尾のスナップショット
4. **設定ファイルのパス一覧**: user / project / local の3階層

### デバッグログに記録される情報

| カテゴリ | 内容 |
|----------|------|
| 起動シーケンス | MDM設定読み込み、mTLS設定、エージェント設定 |
| 権限設定 | allow/deny ルールの適用内容 |
| MCP サーバー | 各MCPサーバーの接続状態・エラー |
| プラグイン | ロード状態、キャッシュパス、バージョン |
| Skills | 読み込み数、ソース（managed/user/project） |
| Hooks | 登録数、ソースプラグイン |
| キーバインド | 読み込み数、ウォッチ対象 |
| ファイル操作 | `.claude.json` のアトミック書き込み（temp→rename） |
| テレメトリ | 有効/無効状態 |

### ログレベル

- `[DEBUG]` — 詳細な動作ログ（大部分がこのレベル）
- `[WARN]` — 警告（テレメトリ無効時のイベントドロップなど）
- `[ERROR]` — エラー（MCP認証失敗、ロック競合など）

## 検出されたエラーの分析

### 1. managed-settings.json 不在（無害）

```
[ERROR] ENOENT: no such file or directory,
open '/Library/Application Support/ClaudeCode/managed-settings.json'
```

- **原因**: MDM（組織管理）用設定ファイル。個人利用では存在しない
- **影響**: なし。30分ごとに再読み込みが試行されるためログに繰り返し記録される
- **対応**: 不要

### 2. MCP サーバー認証エラー

- **対象**: Google Calendar, Gmail, Notion, Figma（claude.ai 統合）
- **原因**: OAuthトークン未設定
- **影響**: 該当サービスのMCPツールが使用不可
- **対応**: 使用する場合はclaude.ai設定画面でOAuth連携が必要

### 3. Config ロック競合

```
[ERROR] Failed to save config with lock: Error: Lock file is already being held
```

- **原因**: 複数のClaude Codeプロセス（worktree等）による同時書き込み
- **影響**: 軽微。リトライにより書き込みは成功する
- **対応**: 不要（設計上想定された動作）

## 活用シーン

| シーン | 活用方法 |
|--------|----------|
| MCPサーバーが動かない | `[ERROR] MCP server` でフィルタして接続状態を確認 |
| 設定が反映されない | 起動シーケンスの権限適用ログを確認 |
| プラグインが読み込まれない | プラグインのロードログとキャッシュパスを確認 |
| パフォーマンス低下 | ロック競合や書き込み頻度を確認 |
| 原因不明の問題 | `[ERROR]` と `[WARN]` を全文検索して問題箇所を特定 |

## 所感

- `/debug` は「Claude Codeの内部状態の可視化」を提供する実用的なコマンド
- 特にMCPサーバーの接続診断において即座に価値を発揮する
- ログがセッションUUIDで管理されるため、過去セッションの問題も遡って調査可能
- 30分ごとの設定再読み込みにより、Claude Codeがホットリロード的な設定管理を持つことが判明
- `.claude.json` のアトミック書き込み（temp file → rename）は、データ整合性を保証する堅実な設計
