# Issue #6: バックグラウンドエージェント強化 - 試行レポート

## 対象バージョン

- v2.1.20, v2.1.47, v2.1.49

## 試行結果

### 1. `background: true` でバックグラウンドタスク実行

- **結果**: 正常動作を確認
- Task ツールに `run_in_background: true` を指定してサブエージェント（Explore タイプ）を起動
- メインの会話はブロックされず、すぐに応答を続行できた
- 完了後に `<task-notification>` として自動的に結果が通知された
- 実行統計: 50,228 tokens / ツール5回使用 / 約13.5秒で完了

### 2. Ctrl+F で全バックグラウンドエージェント終了

- **結果**: 機能の存在を確認（v2.1.47 で ESC 二重押しから Ctrl+F に変更）
- 従来の ESC 二重押しに代わるショートカットとして導入された

### 3. バックグラウンドエージェント起動前のツール権限確認

- **結果**: Hook 経由での権限確認動作を確認
- output_file の JSON ログから `PreToolUse` / `PostToolUse` Hook が正常に実行されていることを観測

### 4. バックグラウンドタスクの結果取得方法

- **結果**: 2つの方法を確認
  1. **output_file**: `/private/tmp/claude-501/.../tasks/<agentId>.output` に JSON Lines 形式で出力される。Read ツールや `tail -f` でリアルタイム監視可能
  2. **完了通知**: エージェント完了時に `<task-notification>` がメイン会話に自動挿入される

## 学んだこと

### run_in_background の位置づけ

- settings.json の設定項目ではなく、**Task ツールの呼び出しパラメータ**
- Claude が自己判断で使用する、または人間が指示して使用させる
- 新しいエージェントの種類ではなく、**既存サブエージェントの実行モードの追加**

### フォアグラウンドとバックグラウンドの違い

| | フォアグラウンド | バックグラウンド |
|---|---|---|
| メイン会話 | ブロックされる | 続行できる |
| 結果の受け取り | 即座に返る | 完了通知で届く |
| 途中経過 | 見えない | output_file で確認可能 |
| エージェントの中身 | 同じ | 同じ |

### 使い分けの判断基準

- **バックグラウンド向き**: 複数独立タスクの並列実行、重い調査中に会話を続けたい場合
- **フォアグラウンド向き**: 結果を待って次のステップに使う場合、単一タスクの場合
